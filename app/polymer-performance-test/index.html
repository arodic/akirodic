<!doctype html>
<html>
<head>
	<title>Polymer template-repeat performance test</title>
	<link rel="import" href="dependencies-vulcanized.html">
	<link rel="import" href="value-array.html">
	<link rel="import" href="value-object.html">
</head>
<body fullbleed>
<script type="text/javascript"></script>

<polymer-element name="polymer-test-app">
  <template>
  <style type="text/css">
    div.sidebar {
      position: relative;
    }
    google-chart {
      width: 100% !important;
      height: 100% !important;
    }
    .note {
      padding: 0.75em;
    }
    .sidebar {
    	position: relative;
    	float: left;
    	width: 400px;
    	height: 100%;
    }
    .content {
    	position: relative;
    	float: left;
    	width: calc(100% - 400px);
    	height: 100%;
    	overflow: hidden;
    }
    paper-slider {
      width: 100%;
    }
    paper-button {
      position: relative;
      display: block;
      width: 100%;
      background: #ddd;
      margin: 0.75em;
    }
    value-array,
    value-object {
      display: none;
    }
  </style>
  <div class="sidebar">
    <div class="note">This test measures performance of Polymer's template-repeat element when iterating on deep recursive arrays and objects.</div>
    <div class="note">Iterations:</div>
    <paper-slider value="{{maxiIterations}}"
      min="1"
      max="100"
      snaps
      editable>
    </paper-slider><br>
    <div class="note">Recursive array/object depth:</div>
    <paper-slider value="{{recursionDepth}}"
      min="0"
      max="3"
      snaps
      editable>
    </paper-slider><br>
    <div class="note">Recursive array/object spread:</div>
    <paper-slider value="{{recursionSpread}}"
      min="1"
      max="100"
      snaps
      editable>
    </paper-slider><br>
    <div class="note">Template repeat</div>
    <paper-button on-tap="{{makeArray}}">Make Array (A)</paper-button>
    <template if="{{arrayValue}}">
      <paper-button on-tap="{{mutateArray}}">Mutate Array (B)</paper-button>
    </template>
    <div class="note">Template repeat observed object to array</div>
    <paper-button on-tap="{{makeObject}}">Make Object (C)</paper-button>
    <template if="{{objectValue}}">
      <paper-button on-tap="{{mutateObject}}">Mutate Object (D)</paper-button>
    </template>
  </div>
  <div class="content">
    <google-chart cols="{{cols}}" rows="{{rows}}" type="stepped-area" options="{'min': 0}" flex></google-chart>
  </div>
  <value-array value="{{arrayValue}}"></value-array>
  <value-object value="{{objectValue}}"></value-object>
  </template>
  <script>
  (function(){

    var createRecursiveObject = function(type, numitems, depth) {
      var object = type === 'array' ? [] : {};
      for (var i = 0; i < numitems; i++) {
        if (depth == 0) {
          object[i] = Math.floor(Math.random() * 100);
        } else {
          object[i] = createRecursiveObject(type, numitems, depth - 1);
        }
      }
      return object;
    }

    var mutateRecursiveObject = function(object) {
      for (var i in object) {
        if (typeof object[i] == 'object') {
          mutateRecursiveObject(object[i]);
        } else {
          object[i] = Math.floor(Math.random() * 100);
        }
      }
    }

    Polymer({

      maxiIterations: 3,
      currentIteration: 0,
      recursionDepth: 2,
      recursionSpread: 10,

      cols: [{"label": "Data", "type": "string"},{"label": "Seconds", "type": "number"}],
      rows: [],

      performPerformanceMeasure: function(dataLabel, callback) {
        this.perfTime = undefined;
        this.currentIteration += 1;
        var time = performance.now();
        requestAnimationFrame(function(){
            this.perfTime = Math.floor(performance.now() - time) / 1000;
            console.log('Done in', this.perfTime);
            this.rows.push([dataLabel, this.perfTime]);
            if (this.currentIteration < this.maxiIterations) {
              callback();
            }
        }.bind(this));
      },

      makeArray: function() {
        this.currentIteration = 0;
        this.makeArrayIteration();
      },
      makeArrayIteration: function() {
        this.performPerformanceMeasure('A', this.makeArrayIteration.bind(this));
        this.arrayValue = createRecursiveObject('array', this.recursionSpread, this.recursionDepth);
        console.log('Created', this.arrayValue);
      },

      mutateArray: function() {
        this.currentIteration = 0;
        this.mutateArrayIteration();
      },
      mutateArrayIteration: function() {
        this.performPerformanceMeasure('B', this.mutateArrayIteration.bind(this));
        mutateRecursiveObject(this.arrayValue);
        console.log('Mutated', this.arrayValue);
      },

      makeObject: function() {
        this.currentIteration = 0;
        this.makeObjectIteration();
      },
      makeObjectIteration: function() {
        this.performPerformanceMeasure('C', this.makeObjectIteration.bind(this));
        this.objectValue = createRecursiveObject('object', this.recursionSpread, this.recursionDepth);
        console.log('Created', this.objectValue);
      },

      mutateObject: function() {
        this.currentIteration = 0;
        this.mutateObjectIteration();
      },
      mutateObjectIteration: function() {
        this.performPerformanceMeasure('D', this.mutateObjectIteration.bind(this));
        mutateRecursiveObject(this.objectValue);
        console.log('Mutated', this.objectValue);
      }

    });
  }());
  </script>
</polymer-element>
<polymer-test-app></polymer-test-app>
</body>
</html>
