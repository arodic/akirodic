<polymer-element name="value-object">
  <template>
    <template if="{{isObject}}">
      <template repeat="{{val in value | observedObjectToArray}}">
        <value-object value="{{val.value}}"></value-object>
      </template>
    </template>
    <template if="{{!isObject}}">
      {{value}}
    </template>
  </template>
  <script>
    // Custom filter used to return an array from an object.
    // Mutations on the object are observed and propagated to array.
    // Array elements are objects containing key and value property.
    // Once Polymer adds support for object iteration, this should be removed.
    // GitHub issue: https://github.com/Polymer/polymer-expressions/issues/11
    PolymerExpressions.prototype.observedObjectToArray = function(object) {
      var array = [];
      array.indexOfObjectKey = function(key) {
        for (var i = 0; i < this.length; i++) {
          if (this[i].key === key) return i;
        }
        return -1;
      }
      if (typeof object == 'object') {
        for (var key in object) {
          array.push({value: object[key], key: key});
        }
        var observer = new ObjectObserver(object);
        observer.open(function(added, removed, changed, getOldValueFn) {
          for (var key in added) {
            array.push({value: added[key], key: key});
          };
          for (var key in removed) {
            var index = array.indexOfObjectKey(key);
            if (index !== -1) {
              array.splice(index, 1);
            }
          };
          for (var key in changed) {
            var index = array.indexOfObjectKey(key);
            if (index !== -1) {
              array[index].value = changed[key];
            }
          };
        }, this);
      }
      return array;
    };

    Polymer({
      publish: {
        /**
         * Value to display.
         * @attribute value
         * @type object
         * @default null
         */
        value: null
      },
      valueChanged: function() {
        this.isObject = typeof this.value === 'object';
      }
    });
  </script>
</polymer-element>